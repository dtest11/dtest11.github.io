---
title: Golang_gc
date: '2021-03-08T16:43:56.000Z'
draft: true
tags:
  - golang
---

# golang\_gc

## 三色标记法

* 标记. 清除 mark ,sweep

### mark and sweep

* stop the world,  mark 
* sweep

not good:

* stw
* 标记需要扫描整个heap
* 清除数据会产生heap碎片

三色标记法

三色标记法 实际上就是通过三个阶段的标记来确定清楚的对象都有哪些. 我们来看一下具体的过程

* 第一步 , 就是只要是新创建的对象,默认的颜色都是标记为“白色
* 第二步, 每次GC回收开始, 然后从根节点开始遍历所有对象，把遍历到的对象从白色集合放入“灰色”集合。
* 第三步, 遍历灰色集合，将灰色对象引用的对象从白色集合放入灰色集合，之后将此灰色对象放入黑色集合
* 第四步, 重复第三步, 直到灰色中无任何对象.
* 第五步: 回收所有的白色标记表的对象. 也就是回收垃圾.

可以看出，有两个问题, 在三色标记法中,是不希望被发生的

条件1: 一个白色对象被黑色对象引用\(白色被挂在黑色下\)

条件2: 灰色对象与它之间的可达关系的白色对象遭到破坏\(灰色同时丢了该白色\)

## 屏障机制

\(2\) 插入屏障 具体操作: 在A对象引用B对象的时候，B对象被标记为灰色。\(将B挂在A下游，B必须被标记为灰色\)

满足: 强三色不变式. \(不存在黑色对象引用白色对象的情况了， 因为白色会强制变成灰色\)

```text
添加下游对象(当前下游对象slot, 新下游对象ptr) {   
  //1
  标记灰色(新下游对象ptr)   

  //2
  当前下游对象slot = 新下游对象ptr                    
}
```

## ref

[https://segmentfault.com/a/1190000022030353](https://segmentfault.com/a/1190000022030353)

